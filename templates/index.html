{% extends "layout.html" %}

{% block body %}
<div class="container" style="display: flex; flex-wrap: wrap; gap: min(5vw,32px); padding: min(5vw,32px); background: #f2f6fc; border-radius: 18px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); max-width: 100vw; box-sizing: border-box;">
  
  <!-- Sol taraf: Profil -->
  <div style="flex: 1 1 260px; min-width: 220px; max-width: 400px; background: white; border-radius: 16px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); padding: min(4vw,24px); display: flex; flex-direction: column; align-items: center; margin-bottom: min(5vw,32px);">
  <img src="{{ url_for('static', filename= data.avatar + '_' +data.level.lower() +'.jpg') }}" alt="Avatar" style="width: min(30vw,180px); height: min(30vw,180px); object-fit: cover; object-position: top; border-radius: 50%; margin-bottom: 16px; box-shadow: 0 2px 12px rgba(0,0,0,0.12); border: 4px solid #e3e8f0; background: #f2f6fc;">
    <p style="font-weight: bold; font-size: 1.1em; margin-bottom: 4px;">Rank: {{data.level}}</p>
    <p style="color: #888;">level {{data.seviye}}</p>
  </div>

  <!-- Saƒü taraf: Yapƒ±lacaklar -->
  <div style="flex: 2 1 340px; min-width: 260px; max-width: 600px; background: white; border-radius: 16px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); padding: min(5vw,32px) min(4vw,24px); display: flex; flex-direction: column; align-items: center; position: relative; min-height: 320px; margin-bottom: min(5vw,32px);">
  <h2 style="text-align: center; margin-bottom: min(3vw,24px); font-size: min(5vw,1.5em); color: #2d3a4a;">Bug√ºn√ºn G√∂revleri</h2>
  
  <div style="width: 100%; max-width: min(90vw,420px);">
    <ul style="list-style: none; padding: 0; margin: 0;">
            {% if habits %}
            {% for habit in habits %} 
                {% set color_map = {'E':'#B0B0B0', 'D':'#FFD966', 'C':'#FFA500', 'B':'#FF8C00', 'A':'#FF6B6B', 'S':'#32CD32'} %}
                <li style="background: #fff; margin-bottom: 18px; padding: 0; border-radius: 14px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); display: flex; align-items: stretch; justify-content: flex-start;">
                    <div style="width: 54px; min-width: 54px; display: flex; align-items: center; justify-content: center; background: {{ color_map[habit.level] }}; border-radius: 14px 0 0 14px; margin-right: 0;">
                        <span title="Ba≈ülangƒ±√ß Seviye" 
                            style="
                                font-weight: bold;
                                font-size: 2em;
                                color: #FFFFFF;
                                text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
                            ">
                        {{ habit.level }}
                        </span>
                    </div>
                    <div style="flex: 1; padding: 12px; display: flex; flex-direction: column; justify-content: space-between;">
                      <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                          <span style="font-size: 1.15em; font-weight: 600; color: #2c3e50;">{{ habit.title }}</span>
                          <span style="font-size: 0.98em; color: #555; margin-top: 4px;">{{ habit.description }}</span>
                          <span style="font-size: 0.92em; color: #888; margin-top: 8px;">
                              üïí {{ habit.streak_count }} g√ºnd√ºr s√ºrd√ºr√ºyorsunuz
                          </span>
                      </div>
                      <div style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 8px;">
                          <a href="/bitti_habits/{{ habit.id }}?next={{ request.path }}" style="background: #13e332ff; color: white; border-radius: 6px; padding: 6px 12px; font-size: 0.9em; text-decoration: none; transition: 0.2s;">Bitti</a>
                          <a href="/duzenle_habits/{{ habit.id }}?next={{ request.path }}" style="background: #13d5e3ff; color: white; border-radius: 6px; padding: 6px 12px; font-size: 0.9em; text-decoration: none; transition: 0.2s;">D√ºzenle</a>
                          <a href="/sil_habits/{{ habit.id }}?next={{ request.path }}" style="background: #e74c3c; color: white; border-radius: 6px; padding: 6px 12px; font-size: 0.9em; text-decoration: none; transition: 0.2s;">Sil</a>
                      </div>
                    </div>
                </li>
            {% endfor %}
            {% else %}
                <div class="alert alert-danger">Tamamlanmayan Alƒ±≈ükanlƒ±k bulunmuyor...</div>
            {% endif %}
        </ul>
    <hr style="border: 0; height: 2px; background-color: #333; margin: 20px 0;">

    <ul style="list-style: none; padding: 0; margin: 0;">
      {% if tasks %}
        {% for task in tasks %}
          <li style="background: #fdfdfd; margin-bottom: 16px; padding: 16px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 8px;">
            
            <!-- G√∂rev Ba≈ülƒ±ƒüƒ± -->
            <span style="font-size: 1.1em; font-weight: 600; color: #2c3e50;">{{ task.title }}</span>
            
            <!-- G√∂rev A√ßƒ±klamasƒ± -->
            <span style="font-size: 0.95em; color: #555;">üìå{{ task.description }}</span>
            
            <!-- Tamamlanma S√ºresi -->
            <span style="font-size: 0.85em; color: #888;">
              ‚è≥ 
              {% if task.days_left is not none %}
                  {% if task.days_left > 0 %}
                      {{ task.days_left }} g√ºn kaldƒ±
                  {% elif task.days_left == 0 %}
                      Bug√ºn Son
                  {% else %}
                      S√ºresi ge√ßti ({{ task.days_left|abs }} g√ºn √∂nce)
                  {% endif %}
              {% else %}
                  S√ºresiz
              {% endif %}
            </span>
            
            <!-- Butonlar -->
            <div style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 8px;">
              <a href="/bitti/{{ task.id }}?next={{ request.path }}" style="background: #13e332ff; color: white; border-radius: 6px; padding: 6px 12px; font-size: 0.9em; text-decoration: none; transition: 0.2s;">Bitti</a>
              <a href="/duzenle/{{ task.id }}?next={{ request.path }}" style="background: #13d5e3ff; color: white; border-radius: 6px; padding: 6px 12px; font-size: 0.9em; text-decoration: none; transition: 0.2s;">D√ºzenle</a>
              <a href="/sil/{{ task.id }}?next={{ request.path }}" style="background: #e74c3c; color: white; border-radius: 6px; padding: 6px 12px; font-size: 0.9em; text-decoration: none; transition: 0.2s;">Sil</a>
            </div>
          </li>
        {% endfor %}
      {% else %}
        <div class="alert alert-danger">Hen√ºz G√∂reviniz bulunmuyor...</div>
      {% endif %}
    </ul>
    
    <!-- G√∂rev Ekle Butonu -->
    <div style="display: flex; justify-content: flex-end; margin-top: 24px;">
      <a href="/ekle/bugun" style="background: #2d7cf4; color: white; border: none; border-radius: 8px; padding: 10px 20px; font-size: 1em; font-weight: 500; cursor: pointer; box-shadow: 0 2px 8px rgba(45,124,244,0.12); transition: background 0.2s; text-decoration: none;">‚ûï G√∂rev Ekle</a>
    </div>
  </div>
</div>


  <!-- G√ºn Notu ve G√ºn Puanƒ± Alanƒ± (ayrƒ± kutu) -->
  <div style="flex: 1 1 220px; min-width: 180px; max-width: 320px; background: #ffef92ff; border-radius: 14px; box-shadow: 0 1px 8px rgba(0,0,0,0.06); padding: min(4vw,24px); display: flex; flex-direction: column; align-items: center; margin-bottom: min(5vw,32px); margin-left: min(2vw,16px);">
    <h3 style="margin-bottom: 12px; color: #2d3a4a;">G√ºn Notu</h3>
    <form method="post" action="/not" style="width: 100%;">
      <textarea name="gun_notu" rows="4" style="width: 100%; border-radius: 8px; border: 1px solid #e3e8f0; padding: 8px; margin-bottom: 12px; resize: vertical; font-size: 1em;" placeholder="Bug√ºn ile ilgili notunuzu yazƒ±n..."></textarea>
      <label for="gun_puani" style="font-weight: 500; margin-bottom: 8px; display: block;">G√ºn Puanƒ± (1-5):</label>
      <select name="gun_puani" id="gun_puani" style="width: 100%; border-radius: 8px; border: 1px solid #e3e8f0; padding: 8px; font-size: 1em; margin-bottom: 16px;">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
      </select>
      <button type="submit" class="btn btn-success" style="width: 100%; border-radius: 8px; font-weight: 500;">Kaydet</button>
    </form>
  </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/api/gunluk-not/bugun')
            .then(response => response.json())
            .then(data => {
                const textarea = document.querySelector('textarea[name="gun_notu"]');
                const select = document.querySelector('select[name="gun_puani"]');
                const button = document.querySelector('button[type="submit"]');

                if (data.exists) {
                    // Not varsa, formu doldur ve butonu g√ºncelle
                    textarea.value = data.note_text;
                    select.value = data.note_rating;
                    button.textContent = "G√ºncelle";
                } else {
                    // Not yoksa, bo≈ü bƒ±rak ve kaydet butonu g√∂ster
                    button.textContent = "Kaydet";
                }
            })
            .catch(error => console.error('Hata:', error));
    });
</script>
{% endblock %}